{% extends "base.html" %}

{% block content %}
<div class="max-w-lg mx-auto" x-data="expenseForm()">
    <h1 class="text-2xl font-bold mb-6 text-gray-800">Nuevo Gasto</h1>

    <form id="expense-form" action="{{ url_for('expenses.new') }}" method="POST" enctype="multipart/form-data"
        class="space-y-4 bg-white p-6 rounded-lg shadow" @submit="validateForm">

        <!-- Captura de Foto -->
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition">
            <input type="file" id="receipt" name="receipt" accept="image/*" capture="camera" required class="hidden"
                @change="previewImage">
            <label for="receipt" class="cursor-pointer block">
                <div x-show="!imagePreview">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <p class="mt-2 text-sm text-gray-600">Tomar foto del comprobante</p>
                </div>
                <img x-show="imagePreview" :src="imagePreview" class="max-w-full h-auto rounded mx-auto"
                    style="display: none;">
            </label>
        </div>

        <!-- Monto -->
        <div>
            <label class="block text-sm font-medium text-gray-700">Monto (CLP)</label>
            <input type="number" name="amount" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm 
                          focus:border-blue-500 focus:ring-blue-500 border p-2">
        </div>

        <!-- Categoría -->
        <div>
            <label class="block text-sm font-medium text-gray-700">Categoría</label>
            <select name="category" required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 bg-white">
                <option value="">Seleccionar...</option>
                <option value="transporte">Transporte</option>
                <option value="alimentacion">Alimentación</option>
                <option value="hospedaje">Hospedaje</option>
                <option value="materiales">Materiales</option>
                <option value="otros">Otros</option>
            </select>
        </div>

        <!-- Cliente (Opcional) -->
        <div>
            <label class="block text-sm font-medium text-gray-700">Cliente</label>
            <select name="client_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 bg-white">
                <option value="">Sin cliente específico</option>
                {% for client in clients %}
                <option value="{{ client.id }}">{{ client.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Motivo -->
        <div>
            <label class="block text-sm font-medium text-gray-700">Motivo del gasto</label>
            <textarea name="reason" rows="3" required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2"></textarea>
        </div>

        <!-- Geolocalización (oculto) -->
        <input type="hidden" name="latitude" x-model="latitude">
        <input type="hidden" name="longitude" x-model="longitude">

        <!-- Estado de Ubicación -->
        <div class="text-sm p-2 rounded"
            :class="locationError ? 'bg-red-100 text-red-700' : (latitude ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700')">
            <p x-text="locationStatus"></p>
            <button type="button" x-show="locationError" @click="getLocation()"
                class="underline mt-1">Reintentar</button>
        </div>

        <!-- Botón Submit -->
        <button type="submit"
            class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 
                       focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
            Registrar Gasto
        </button>
    </form>
</div>

<script>
    function expenseForm() {
        return {
            imagePreview: null,
            latitude: null,
            longitude: null,
            locationStatus: 'Obteniendo ubicación...',
            locationError: false,

            init() {
                this.getLocation();
            },

            previewImage(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.imagePreview = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },

            getLocation() {
                this.locationStatus = 'Obteniendo ubicación...';
                this.locationError = false;

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            this.latitude = position.coords.latitude;
                            this.longitude = position.coords.longitude;
                            this.locationStatus = 'Ubicación obtenida correctamente';
                            this.locationError = false;
                        },
                        (error) => {
                            console.log('Error getting location:', error);
                            this.locationStatus = 'Error: No se pudo obtener la ubicación. Es obligatoria.';
                            this.locationError = true;
                            this.latitude = null;
                            this.longitude = null;
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    this.locationStatus = 'Error: Tu navegador no soporta geolocalización.';
                    this.locationError = true;
                }
            },

            validateForm(event) {
                if (!this.latitude || !this.longitude) {
                    event.preventDefault();
                    alert('La ubicación es obligatoria. Por favor, asegúrate de permitir el acceso a la ubicación y vuelve a intentarlo.');
                    this.getLocation(); // Retry
                }
            }
        }
    }
</script>
{% endblock %}